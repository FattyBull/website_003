<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Content Management</title>
    <!-- KORREKTUR: TinyMCE wird von einem anderen CDN geladen, um das "read-only"-Problem zu beheben -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f6f8; color: #212529; margin: 0; }
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input[type="text"], select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #dee2e6; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        /* Das normale Textarea wird vom Editor ersetzt */
        textarea#summary { min-height: 100px; }
        button { display: block; width: 100%; padding: 1rem; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.2rem; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #response { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Content Management</h1>
        <form id="article-form">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="slug">Slug (URL-friendly version of the title)</label>
                <input type="text" id="slug" name="slug" required>
            </div>
            <div class="form-group">
                <label for="summary">Summary (for the article card)</label>
                <textarea id="summary" name="summary" required></textarea>
            </div>
            <div class="form-group">
                <label for="body_html">Article Body (HTML)</label>
                <!-- Dieses Textarea wird durch den Editor ersetzt -->
                <textarea id="body_html" name="body_html"></textarea>
            </div>
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category" required>
                    <option value="News">News</option>
                    <option value="Players">Players</option>
                    <option value="Creators">Creators</option>
                </select>
            </div>
             <div class="form-group">
                <label for="image_path">Image Path (e.g., /media/my-image.webp)</label>
                <input type="text" id="image_path" name="image_path" required>
            </div>
            <div class="form-group">
                <label for="published_at">Publish Date (YYYY-MM-DD HH:MM:SS)</label>
                <input type="text" id="published_at" name="published_at" required>
            </div>
            <button type="submit">Publish Article</button>
        </form>
        <div id="response"></div>
    </div>

    <script>
        // Initialisiert den Rich-Text-Editor
        tinymce.init({
            selector: 'textarea#body_html',
            plugins: 'code lists link image media table wordcount',
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | table'
        });

        // Automatisches Generieren des Slugs aus dem Titel
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');

        const slugify = (text) => {
            return text
                .toString()
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')           // Leerzeichen durch - ersetzen
                .replace(/[^\w\-]+/g, '')       // Alle nicht-Wort-Zeichen entfernen
                .replace(/\-\-+/g, '-');        // Mehrfache -- durch einen ersetzen
        };

        titleInput.addEventListener('input', () => {
            slugInput.value = slugify(titleInput.value);
        });


        document.getElementById('article-form').addEventListener('submit', function(event) {
            event.preventDefault();

            // Holt den Inhalt aus dem Editor
            const bodyHtmlContent = tinymce.get('body_html').getContent();

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.body_html = bodyHtmlContent; // Ãœberschreibt den leeren Textarea-Wert mit dem Editor-Inhalt

            data.secret_key = 'Z@xR9!c$vB&n M*kLp2s5v8y/B?E(H+KbPeShVmYq3t6w9z$C&F)J@NcQfTjWnZr4u7x!A%D*G-KaPdSgUkXp2s5v8y/B?E(H+KbPeShVmYq3t6w9z$C&F)J@NcQfTjWn';

            const responseDiv = document.getElementById('response');
            responseDiv.style.display = 'none';
            
            fetch('http://hammerbanger.com/api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                responseDiv.style.display = 'block';
                if (result.success) {
                    responseDiv.className = 'success';
                    responseDiv.textContent = result.message;
                    form.reset();
                    tinymce.get('body_html').setContent(''); // Editor-Inhalt leeren
                    document.getElementById('published_at').value = getCurrentDateTime();
                } else {
                    responseDiv.className = 'error';
                    responseDiv.textContent = 'Error: ' + result.message;
                }
            })
            .catch(error => {
                responseDiv.style.display = 'block';
                responseDiv.className = 'error';
                responseDiv.textContent = 'A critical network error occurred: ' + error.message;
            });
        });

        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        document.getElementById('published_at').value = getCurrentDateTime();
    </script>
</body>
</html>
